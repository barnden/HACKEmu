function assemble(){let e=[],t={},a={SCREEN:16384,KBD:24576},s=document.getElementById("asm-inp").value.split("\n");for(let e in s){let a=s[e];a=a.replace(/\s+|\/\/.*/g,""),""!=a&&(t[e]=a)}let r=0;for(let e in t){let s=t[e];if("("==s[0]){if(")"!=s[s.length-1])return;a[s.substr(1,s.length-2)]=r,delete t[e]}else r++}r=0;for(let e in t){let s=t[e];if("@"==s[0]){let l=s.substr(1);if("R"==l[0]&&is_int(l.substr(1))&&(l=l.substr(1),t[e]="@"+l),!is_int(l)){if(!a.hasOwnProperty(l)){let e=16+r,t=Object.values(a),s=t.includes(e);if(!COMPATIBILITY)for(;s;){s=!1;for(let a of t)if(a==e){s=!0,e++;break}}a[l]=e,r++}t[e]="@"+a[l]}}}for(let a in t){let s=t[a],r=s[0],l=null;switch(r){case"@":if(l=asm_a_instruction(s,a),null==l)return;e.push(l);break;case"M":case"A":case"D":if(l=asm_c_instruction(s,a),null==l)return;e.push(l);break;case"0":case"1":let t=s.match(/-?\d+;?/);if(null!=t){if(t=t[0],t=t.replace(";",""),1==t.length){if(l=asm_c_instruction(s,a),null==l)return;e.push(l);break}r=t}case"-":case"!":if(r=s.split(";")[0],["-1","-A","-D","-M","!D","!A","!M"].includes(r)){if(l=asm_c_instruction(s,a),null==l)return;e.push(l);break}default:return}}ROM.asm=[];for(let e in t)ROM.asm.push(t[e]);ROM.dec=e,reset()}function asm_a_instruction(e){return(e=parseInt(e.substr(1)))>32767||e<0?null:e}function asm_c_instruction(e){let t,a,s;t=e.substr(0,e.indexOf("="));let r=(e=e.substr(e.indexOf("=")+1)).split(";");a=r[0],s=r[1]||"";let l=dests.indexOf(t);if(-1==l)return null;let n=comps[a];if(null==n)return null;let i=jumps.indexOf(s);if(-1==l)return null;let o=0;return o=57344,o|=n<<6,o|=l<<3,o|=i,o}jumps=["","JGT","JEQ","JGE","JLT","JNE","JLE","JMP"],dests=["","M","D","MD","A","AM","AD","AMD"],comps={0:42,1:63,"-1":58,D:12,A:48,M:112,"!D":13,"!A":49,"!M":113,"-D":15,"-A":51,"-M":115,"D+1":31,"A+1":55,"M+1":119,"D-1":14,"A-1":50,"M-1":114,"D+A":2,"D-A":19,"A-D":7,"D+M":66,"D-M":83,"M-D":71,"D&A":0,"D&M":64,"D|A":21,"D|M":85},comps["A+D"]=comps["D+A"],comps["M+D"]=comps["D+M"],comps["A&D"]=comps["D&A"],comps["D&M"]=comps["M&D"],comps["A|D"]=comps["D|A"],comps["D|M"]=comps["M|D"];var ROM={asm:[],dec:[]};RAM={};const MODES=["asm","dec","hex","oct","bin"];var MODE,FREQ=10,IPC=1,RADIX=10,DIGITS=5;function set_mode(e){if(e=e.toLowerCase(),MODES.includes(e)){switch(MODE=MODES.indexOf(e)){case 2:RADIX=16;break;case 3:RADIX=8;break;case 4:RADIX=2;break;default:RADIX=10}DIGITS=Math.ceil(Math.log(65536)/Math.log(RADIX))}}set_mode("asm");var PC=0,OPC=0,A=0,D=0;let op="";function sub(e,t){return into_twos(from_twos(e)-from_twos(t))}function add(e,t){return into_twos(from_twos(e)+from_twos(t))}function neg(e){return into_twos(-from_twos(e))}function into_twos(e){return e<0&&(e*=-1,e^=65535,e++),65535&e}function from_twos(e){return e>>15==1&&(e^=65535,e++,e*=-1),e}function write_RAM(e,t){if(24576!=e){if(set_active("RAM-"+e),e>=16384){let a=16*(e-16384),s=a%512,r=Math.floor(a/512);for(let e=0;e<16;e++)draw_pixel(s++,r,t>>e&1)}}else active_chg=!0;RAM[e]=t}function execute(){set_active("ROM-"+PC),OPC=PC;let e=ROM.dec[PC++];if(32768&e){e&=8191,a=(4096&e)>>>12,comp=(4032&e)>>>6,dest=(56&e)>>>3,jump=7&e;let t=void 0,s=a?RAM[A]||0:A,r=a?"M":"A";switch(alu_data[0]=D,alu_data[1]=s,comp){case 42:t=0,op=0;break;case 63:t=1;break;case 58:t=into_twos(-1),op=-1;break;case 12:t=into_twos(D),op="D";break;case 48:t=into_twos(s),op=r;break;case 13:t=into_twos(~D),op="~D";break;case 49:t=into_twos(~s),op="~"+r;break;case 15:t=neg(D),op="-D";break;case 51:t=neg(s),op="-"+r;break;case 31:t=add(D,1),op="D + 1";break;case 55:t=add(s,1),op=a?"M":"A + 1";break;case 14:t=sub(D,1),op="D - 1";break;case 50:t=sub(s,1),op=a?"M":"A - 1";break;case 2:t=add(D,s),op="D + "+r;break;case 19:t=sub(D,s),op="D - "+r;break;case 7:t=sub(s,D),op=r+" - D";break;case 0:t=into_twos(D&s),op="D & "+r;break;case 21:t=into_twos(D|s),op="D | "+r;break;default:return}let l=from_twos(t);switch(dest){case 0:break;case 1:write_RAM(A,t);break;case 2:D=t;break;case 3:write_RAM(A,t),D=t;break;case 4:A=t;break;case 5:write_RAM(A,t),A=t;break;case 6:A=t,D=t;break;case 7:write_RAM(A,t),A=t,D=t;break;default:return}let n=from_twos(A);switch(jump){case 0:break;case 1:l>0&&(PC=n);break;case 2:0==l&&(PC=n);break;case 3:l>=0&&(PC=n);break;case 4:l<0&&(PC=n);break;case 5:0!=l&&(PC=n);break;case 6:l<=0&&(PC=n);break;case 7:PC=n;break;default:return}alu_data[2]=t,alu_data[3]=op}else A=e}var RUNNING=!1;function reset(){RUNNING=!1,A=0,D=0,PC=0,OPC=0,set_active("ROM-0"),set_active("RAM-0"),updateRegisters(A,D,PC),RAM={};for(let e=0;e<512;e++)for(let t=0;t<256;t++)draw_pixel(e,t,0)}function run(){RUNNING=!0,loop()}function loop(){if(RUNNING){for(let e=0;e<IPC;e++)execute();PC>32767&&(RUNNING=!1),setTimeout(loop,Math.max(1,Math.ceil(1/FREQ*1e3)))}}var canvas=document.getElementById("screen"),ctx=canvas.getContext("2d");ctx.beginPath(),ctx.rect(0,0,512,256),ctx.fillStyle="#"+BG.toString(16),ctx.fill(),ctx.beginPath();var img=ctx.getImageData(0,0,512,256),pixels=img.data,screen_update=!1;function draw_pixel(e,t,a){let s=4*(t*img.width+e),r=a?FG:BG;pixels[s]=r>>16,pixels[s+1]=r>>8&255,pixels[s+2]=255&r,pixels[s+3]=255,screen_update=!0}function render(){window.requestAnimationFrame(render),screen_update&&(ctx.putImageData(img,0,0),screen_update=!1)}render();var registers=[document.getElementById("tar"),document.getElementById("trd"),document.getElementById("tpc"),document.getElementById("tkb")],alu_io=[document.getElementById("tdin"),document.getElementById("tmain"),document.getElementById("tout"),document.getElementById("tmux")];let alu_data=[0,0,0,0];function updateALU(e,t,a,s){alu_io[0].value=from_twos(e),alu_io[1].value=from_twos(t),alu_io[2].value=from_twos(a),alu_io[3].value=from_twos(s)}function updateRegisters(e,t,a){registers[0].value=from_twos(e),registers[1].value=from_twos(t),registers[2].value=from_twos(a)}var ROM_html=document.getElementById("ROM-view"),RAM_html=document.getElementById("RAM-view"),rom_active=void 0,ram_active=void 0,active_chg=!1;function set_active(e){if(!(e=e||window.location.hash.substr(1)).length)return;let t=e.substr(0,3);if(!["RAM","ROM"].includes(t))return;let a=parseInt(e.substr(4));if(isNaN(a))return;let s=Math.max(0,22*(a-12));"ROM"==t?(ROM_html.scrollTop=s,rom_active=e,active_chg=!0):(RAM_html.scrollTop=s,ram_active=e,active_chg=!0)}function active_loop(){active_chg&&(virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL),updateRegisters(A,D,OPC),updateALU(alu_data[0],alu_data[1],alu_data[2],alu_data[3]),active_chg=!1),window.requestAnimationFrame(active_loop)}window.addEventListener("hashchange",()=>{set_active()});const ROW_HEIGHT=22,MAX_VISIBLE=550,RAM_TOTAL=24577,ROM_TOTAL=32768;function int_str(e,t){let a;return t||1==MODE?a=from_twos(e):(a=e.toString(RADIX),a=a.padStart(DIGITS,"0")),a}function get_ROM(e){return MODE?int_str(ROM.dec[e]?ROM.dec[e]:0):ROM.asm[e]?ROM.asm[e]:0}function get_RAM(e){return int_str(RAM.hasOwnProperty(e)?RAM[e]:0,!MODE)}function virtual_scroll(e,t,a){let s=Math.max(0,Math.floor(e.scrollTop/22)),r=Math.min(27,a-s),l=22*s,n="ROM"==t?get_ROM:get_RAM,i=[];for(let e=0;e<r;e++){let a=e+s,r="",l=t+"-"+a;"RAM"==t&&(24576==a?r='class="kbd"':a>=16384&&(r='class="scr"')),ram_active!=l&&rom_active!=l||(r='class="active"'),i.push(`<div id="${l}" ${r}><span>${a}</span>${n(a)}</div>`)}e.innerHTML=`<div style="height: ${22*a}px; overflow: auto;"><div style="transform: translateY(${l}px);">${i.join("")}</div></div>`}ROM_html.addEventListener("scroll",()=>{virtual_scroll(ROM_html,"ROM",ROM_TOTAL)}),RAM_html.addEventListener("scroll",()=>{virtual_scroll(RAM_html,"RAM",RAM_TOTAL)});let freq=document.getElementById("freq"),ipc=document.getElementById("ipc"),slider=document.getElementById("slider"),slider2=document.getElementById("slider2");slider.addEventListener("change",()=>{let e=parseInt(slider.value);e<1?slider.value=1:e>500&&(slider.value=500),freq.value=e,FREQ=parseInt(freq.value)}),freq.addEventListener("change",()=>{let e=parseInt(freq.value);e<1?freq.value=1:e>500&&(freq.value=500),slider.value=e,FREQ=parseInt(freq.value)}),ipc.addEventListener("change",()=>{let e=parseInt(ipc.value);e<1?ipc.value=1:e>2e3&&(ipc.value=2e3),slider2.value=e,IPC=e}),slider2.addEventListener("change",()=>{let e=parseInt(slider2.value);e<1?slider2.value=1:e>2e3&&(slider2.value=2e3),ipc.value=e,IPC=parseInt(ipc.value)});let mode=document.getElementById("mode");mode.addEventListener("change",()=>{set_mode(mode.selectedOptions[0].value),virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL)}),window.addEventListener("load",()=>{virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL),set_mode(mode.selectedOptions[0].value),updateRegisters(0,0,0),updateALU(0,0,0,""),FREQ=parseInt(freq.value),IPC=parseInt(ipc.value),set_active("ROM-0"),set_active("RAM-0"),active_loop()}),document.addEventListener("keydown",e=>{1==e.key.length&&(registers[3].value=e.key,write_RAM(24576,COMPATIBILITY?e.key.toUpperCase().charCodeAt(0):e.key.charCodeAt(0)))}),document.addEventListener("keyup",()=>{registers[3].value="",write_RAM(24576,0)});