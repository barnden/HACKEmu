function assemble(){let e=[],t={},a={SCREEN:16384},r=document.getElementById("asm-inp").value.split("\n");for(let e in r){let a=r[e];a=a.replace(/\s+|\/\/.*/g,""),""!=a&&(t[e]=a)}let s=0;for(let e in t){let r=t[e];if("("==r[0]){if(")"!=r[r.length-1])return;a[r.substr(1,r.length-2)]=s,delete t[e]}else s++}s=0;for(let e in t){let r=t[e];if("@"==r[0]){let n=r.substr(1);is_int(n)||(a.hasOwnProperty(n)||(a[n]=16+s,s++),t[e]="@"+a[n])}}for(let a in t){let r=t[a],s=r[0],n=null;switch(s){case"@":if(n=asm_a_instruction(r,a),null==n)return;e.push(n);break;case"M":case"A":case"D":if(n=asm_c_instruction(r,a),null==n)return;e.push(n);break;case"0":case"1":let t=r.match(/-?\d+;?/);if(null!=t){if(t=t[0],t=t.replace(";",""),1==t.length){if(n=asm_c_instruction(r,a),null==n)return;e.push(n);break}s=t}case"-":case"!":if(s=r.split(";")[0],["-1","-A","-D","-M","!D","!A","!M"].includes(s)){if(n=asm_c_instruction(r,a),null==n)return;e.push(n);break}default:return}}ROM.asm=[];for(let e in t)ROM.asm.push(t[e]);ROM.dec=e,reset()}function asm_a_instruction(e){return(e=parseInt(e.substr(1)))>32767||e<0?null:e}function asm_c_instruction(e){let t,a,r;t=e.substr(0,e.indexOf("="));let s=(e=e.substr(e.indexOf("=")+1)).split(";");a=s[0],r=s[1]||"",t=dests.indexOf(t),a=comps[a],r=jumps.indexOf(r);let n=0;return n=57344,n|=a<<6,n|=t<<3,n|=r,n}jumps=["","JGT","JEQ","JGE","JLT","JNE","JLE","JMP"],dests=["","M","D","MD","A","AM","AD","AMD"],comps={0:42,1:63,"-1":58,D:12,A:48,M:112,"!D":13,"!A":49,"!M":113,"-D":15,"-A":51,"-M":115,"D+1":31,"A+1":55,"M+1":119,"D-1":14,"A-1":50,"M-1":114,"D+A":2,"D-A":19,"A-D":7,"D+M":66,"D-M":83,"M-D":71,"D&A":0,"D&M":64,"D|A":21,"D|M":85};var ROM={asm:[],dec:[]};RAM={};const MODES=["asm","dec","hex","oct","bin"];var MODE,FREQ=10,IPC=1,RADIX=10,DIGITS=5;function set_mode(e){if(e=e.toLowerCase(),MODES.includes(e)){switch(MODE=MODES.indexOf(e)){case 2:RADIX=16;break;case 3:RADIX=8;break;case 4:RADIX=2;break;default:RADIX=10}DIGITS=Math.ceil(Math.log(65536)/Math.log(RADIX))}}set_mode("asm");var PC=0,OPC=0,A=0,D=0;let op="";function sub(e,t){return into_twos(from_twos(e)-from_twos(t))}function add(e,t){return into_twos(from_twos(e)+from_twos(t))}function neg(e){return into_twos(-from_twos(e))}function into_twos(e){return e<0&&(e*=-1,e^=65535,e++),65535&e}function from_twos(e){return e>>15==1&&(e^=65535,e++,e*=-1),e}function writeRAM(e,t){if(set_active("RAM-"+e),RAM[e]=t,e>=16384){let t=16*(e-16384),a=t%512,r=Math.floor(t/512);for(let t=0;t<16;t++)draw_pixel(a++,r,RAM[e]>>t&1)}}function execute(){set_active("ROM-"+PC),OPC=PC;let e=ROM.dec[PC++];if(32768&e){e&=8191,a=(4096&e)>>>12,comp=(4032&e)>>>6,dest=(56&e)>>>3,jump=7&e;let t=void 0,r=a?RAM[A]||0:A,s=a?"M":"A";switch(alu_data[0]=D,alu_data[1]=r,comp){case 42:t=0,op=0;break;case 63:t=1;break;case 58:t=into_twos(-1),op=-1;break;case 12:t=into_twos(D),op="D";break;case 48:t=into_twos(r),op=s;break;case 13:t=into_twos(~D),op="~D";break;case 49:t=into_twos(~r),op="~"+s;break;case 15:t=neg(D),op="-D";break;case 51:t=neg(r),op="-"+s;break;case 31:t=add(D,1),op="D + 1";break;case 55:t=add(r,1),op=a?"M":"A + 1";break;case 14:t=sub(D,1),op="D - 1";break;case 50:t=sub(r,1),op=a?"M":"A - 1";break;case 2:t=add(D,r),op="D + "+s;break;case 19:t=sub(D,r),op="D - "+s;break;case 7:t=sub(r,D),op=s+" - D";break;case 0:t=into_twos(D&r),op="D & "+s;break;case 21:t=into_twos(D|r),op="D | "+s;break;default:return}let n=from_twos(t);switch(dest){case 0:break;case 1:writeRAM(A,t);break;case 2:D=t;break;case 3:writeRAM(A,t),D=t;break;case 4:A=t;break;case 5:writeRAM(A,t),A=t;break;case 6:A=t,D=t;break;case 7:writeRAM(A,t),A=t,D=t;break;default:return}let l=from_twos(A);switch(jump){case 0:break;case 1:n>0&&(PC=l);break;case 2:0==n&&(PC=l);break;case 3:n>=0&&(PC=l);break;case 4:n<0&&(PC=l);break;case 5:0!=n&&(PC=l);break;case 6:n<=0&&(PC=l);break;case 7:PC=l;break;default:return}alu_data[2]=t,alu_data[3]=op}else A=e}var RUNNING=!1;function reset(){RUNNING=!1,A=0,D=0,PC=0,OPC=0,set_active("ROM-0"),set_active("RAM-0"),updateRegisters(A,D,PC),RAM={};for(let e=0;e<512;e++)for(let t=0;t<256;t++)draw_pixel(e,t,0)}function run(){RUNNING=!0,loop()}function loop(){if(RUNNING){for(let e=0;e<IPC;e++)execute();PC>32767&&(RUNNING=!1),setTimeout(loop,Math.max(1,Math.ceil(1/FREQ*1e3)))}}var canvas=document.getElementById("screen"),ctx=canvas.getContext("2d");ctx.beginPath(),ctx.rect(0,0,512,256),ctx.fillStyle="#"+BG.toString(16),ctx.fill(),ctx.beginPath();var img=ctx.getImageData(0,0,512,256),pixels=img.data,screen_update=!1;function draw_pixel(e,t,a){let r=4*(t*img.width+e),s=a?FG:BG;pixels[r]=s>>16,pixels[r+1]=s>>8&255,pixels[r+2]=255&s,pixels[r+3]=255,screen_update=!0}function render(){window.requestAnimationFrame(render),screen_update&&(ctx.putImageData(img,0,0),screen_update=!1)}render();var registers=[document.getElementById("tar"),document.getElementById("trd"),document.getElementById("tpc"),document.getElementById("tkb")];let input=0;document.addEventListener("keydown",e=>{input=e.key,registers[3].value=e.key}),document.addEventListener("keyup",()=>{input=0,registers[3].value=""});var alu_io=[document.getElementById("tdin"),document.getElementById("tmain"),document.getElementById("tout"),document.getElementById("tmux")];let alu_data=[0,0,0,0];function updateALU(e,t,a,r){alu_io[0].value=from_twos(e),alu_io[1].value=from_twos(t),alu_io[2].value=from_twos(a),alu_io[3].value=from_twos(r)}function updateRegisters(e,t,a){registers[0].value=from_twos(e),registers[1].value=from_twos(t),registers[2].value=from_twos(a)}var ROM_html=document.getElementById("ROM-view"),RAM_html=document.getElementById("RAM-view"),rom_active=void 0,ram_active=void 0,active_chg=!1;function set_active(e){if(!(e=e||window.location.hash.substr(1)).length)return;let t=e.substr(0,3);if(!["RAM","ROM"].includes(t))return;let a=parseInt(e.substr(4));if(isNaN(a))return;let r=Math.max(0,22*(a-12));"ROM"==t?(ROM_html.scrollTop=r,rom_active=e,active_chg=!0):(RAM_html.scrollTop=r,ram_active=e,active_chg=!0)}function active_loop(){active_chg&&(virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL),updateRegisters(A,D,OPC),updateALU(alu_data[0],alu_data[1],alu_data[2],alu_data[3]),active_chg=!1),window.requestAnimationFrame(active_loop)}window.addEventListener("hashchange",()=>{set_active()});const ROW_HEIGHT=22,MAX_VISIBLE=550,RAM_TOTAL=24577,ROM_TOTAL=32768;function int_str(e,t){let a;return t||1==MODE?a=from_twos(e):(a=e.toString(RADIX),a=a.padStart(DIGITS,"0")),a}function get_ROM(e){return MODE?int_str(ROM.dec[e]?ROM.dec[e]:0):ROM.asm[e]?ROM.asm[e]:0}function get_RAM(e){return int_str(RAM.hasOwnProperty(e)?RAM[e]:0,!MODE)}function virtual_scroll(e,t,a){let r=Math.max(0,Math.floor(e.scrollTop/22)),s=Math.min(27,a-r),n=22*r,l="ROM"==t?get_ROM:get_RAM,i=[];for(let e=0;e<s;e++){let a=e+r,s="",n=t+"-"+a;"RAM"==t&&(24576==a?s='class="kbd"':a>=16384&&(s='class="scr"')),ram_active!=n&&rom_active!=n||(s='class="active"'),i.push(`<div id="${n}" ${s}><span>${a}</span>${l(a)}</div>`)}e.innerHTML=`<div style="height: ${22*a}px; overflow: auto;"><div style="transform: translateY(${n}px);">${i.join("")}</div></div>`}ROM_html.addEventListener("scroll",()=>{virtual_scroll(ROM_html,"ROM",ROM_TOTAL)}),RAM_html.addEventListener("scroll",()=>{virtual_scroll(RAM_html,"RAM",RAM_TOTAL)});let freq=document.getElementById("freq"),ipc=document.getElementById("ipc"),slider=document.getElementById("slider"),slider2=document.getElementById("slider2");slider.addEventListener("change",()=>{let e=parseInt(slider.value);e<1?slider.value=1:e>500&&(slider.value=500),freq.value=e,FREQ=parseInt(freq.value)}),freq.addEventListener("change",()=>{let e=parseInt(freq.value);e<1?freq.value=1:e>500&&(freq.value=500),slider.value=e,FREQ=parseInt(freq.value)}),ipc.addEventListener("change",()=>{let e=parseInt(ipc.value);e<1?ipc.value=1:e>2e3&&(ipc.value=2e3),slider2.value=e,IPC=e}),slider2.addEventListener("change",()=>{let e=parseInt(slider2.value);e<1?slider2.value=1:e>2e3&&(slider2.value=2e3),ipc.value=e,IPC=parseInt(ipc.value)});let mode=document.getElementById("mode");mode.addEventListener("change",()=>{set_mode(mode.selectedOptions[0].value),virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL)}),window.addEventListener("load",()=>{virtual_scroll(ROM_html,"ROM",ROM_TOTAL),virtual_scroll(RAM_html,"RAM",RAM_TOTAL),set_mode(mode.selectedOptions[0].value),updateRegisters(0,0,0),updateALU(0,0,0,""),FREQ=parseInt(freq.value),IPC=parseInt(ipc.value),set_active("ROM-0"),set_active("RAM-0"),active_loop()});